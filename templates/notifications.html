{% extends "base.html" %}

{% block title %}Notifications - BudgetMaster{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2"><i class="fas fa-bell me-2"></i>Notifications
        {% if unread_count > 0 %}
            <span class="notification-badge">{{ unread_count }}</span>
        {% endif %}
    </h1>
    <button class="btn btn-outline-secondary" onclick="markAllAsRead()">
        <i class="fas fa-check-double me-1"></i>Marquer tout comme lu
    </button>
</div>

<!-- Invitations en attente -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Invitations en attente</h5>
            </div>
            <div class="card-body">
                {% if pending_invitations %}
                    {% for invitation in pending_invitations %}
                    <div class="notification-item mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-user-plus text-primary me-2"></i>
                                    <strong>{{ invitation.sender.username }}</strong>
                                    <span class="text-muted ms-2">vous invite à rejoindre</span>
                                    <strong class="text-primary ms-1">{{ invitation.group.name }}</strong>
                                </div>
                                <p class="mb-2 text-muted small">
                                    {% if invitation.group.description %}
                                        {{ invitation.group.description }}
                                    {% endif %}
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ invitation.created_at.strftime('%d/%m/%Y à %H:%M') }}
                                </small>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('accept_invitation_from_groups', invitation_id=invitation.id) }}"
                                   class="btn btn-success btn-sm">
                                    <i class="fas fa-check me-1"></i>Accepter
                                </a>
                                <a href="{{ url_for('reject_invitation_from_groups', invitation_id=invitation.id) }}"
                                   class="btn btn-danger btn-sm">
                                    <i class="fas fa-times me-1"></i>Refuser
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-envelope-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Aucune invitation en attente</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Notifications récentes -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Notifications récentes</h5>
            </div>
            <div class="card-body">
                {% if notifications %}
                    {% for notification in notifications %}
                    <div class="notification-item mb-3 p-3 border rounded {% if not notification.is_read %}bg-light{% endif %}" data-notification-id="{{ notification.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    {% if notification.type == 'group_join' %}
                                        <i class="fas fa-user-plus text-success me-2"></i>
                                    {% elif notification.type == 'group_expense' %}
                                        <i class="fas fa-euro-sign text-warning me-2"></i>
                                    {% elif notification.type == 'group_invitation' %}
                                        <i class="fas fa-envelope text-primary me-2"></i>
                                    {% else %}
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                    {% endif %}
                                    <strong>{{ notification.title }}</strong>
                                </div>
                                <p class="mb-2 text-muted small">{{ notification.message }}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ notification.created_at.strftime('%d/%m/%Y à %H:%M') }}
                                    {% if notification.group %}
                                        • <a href="{{ url_for('group_detail', group_id=notification.group.id) }}" class="text-decoration-none">{{ notification.group.name }}</a>
                                    {% endif %}
                                </small>
                            </div>
                            {% if not notification.is_read %}
                            <div>
                                <span class="badge bg-primary">Nouveau</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Aucune notification récente</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Notifications de groupes -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Activités des groupes</h5>
            </div>
            <div class="card-body">
                {% if user_groups %}
                    {% for group_membership in user_groups %}
                    {% set group = group_membership.group %}
                    <div class="notification-item mb-3 p-3 border rounded">
                        <div class="d-flex align-items-start">
                            <div class="avatar-circle me-3" style="background: var(--primary-gradient);">
                                {{ group.name[0].upper() }}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ group.name }}</h6>
                                        <p class="mb-1 text-muted small">
                                            {% set expense_count = group.expenses|length %}
                                            {% if expense_count > 0 %}
                                                {{ expense_count }} dépense{{ 's' if expense_count > 1 else '' }}
                                                {% set total = 0 %}
                                                {% for exp in group.expenses %}
                                                    {% set total = total + exp.amount %}
                                                {% endfor %}
                                                • {{ "%.3f"|format(total) }} DT
                                            {% else %}
                                                Aucune dépense pour le moment
                                            {% endif %}
                                        </p>
                                        {% if group.date_sortie %}
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>
                                            Prochaine sortie: {{ group.date_sortie.strftime('%d/%m/%Y') }}
                                            {% if group.heure_sortie %}à {{ group.heure_sortie.strftime('%H:%M') }}{% endif %}
                                        </small>
                                        {% endif %}
                                    </div>
                                    <a href="{{ url_for('group_detail', group_id=group.id) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>Voir
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Vous n'êtes membre d'aucun groupe</p>
                        <a href="{{ url_for('groups') }}" class="btn btn-primary">
                            Découvrir les groupes
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Notifications système -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations système</h5>
            </div>
            <div class="card-body">
                <div class="notification-item p-3 border rounded">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-shield-alt text-info me-3 fa-2x"></i>
                        <div>
                            <h6 class="mb-1">Sécurité de vos données</h6>
                            <p class="mb-0 text-muted small">
                                Vos données financières sont chiffrées et stockées en toute sécurité.
                                Nous ne partageons jamais vos informations avec des tiers.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    
    // Join notifications page room
    socket.emit('join_notifications_page');
    
    // Listen for notifications updates
    socket.on('notifications_update', function(data) {
        console.log('Notifications update:', data);
        
        if (data.unread_notifications_count !== undefined) {
            // Update unread count in the header
            updateUnreadCount(data.unread_notifications_count);
        }
        
        if (data.pending_invitations && data.pending_invitations.length > 0) {
            // Update pending invitations section
            updatePendingInvitations(data.pending_invitations);
        }
    });
    
    socket.on('new_invitation_received', function(data) {
        console.log('New invitation received:', data);
        showNotification(data.message, 'info');
        // Refresh the page to show new invitation
        setTimeout(() => location.reload(), 1000);
    });
    
    socket.on('invitations_update', function(data) {
        console.log('Invitations update:', data);
        if (data.pending_count !== undefined) {
            // Update pending invitations count
            // This might require refreshing the page or updating the DOM
            if (data.pending_count === 0) {
                // If no more pending invitations, hide the section or refresh
                const pendingSection = document.querySelector('.card-header:contains("Invitations en attente")');
                if (pendingSection) {
                    location.reload(); // Simple solution for now
                }
            }
        }
    });
    
    socket.on('group_member_joined', function(data) {
        console.log('Group member joined:', data);
        showNotification(data.message, 'success');
        // Add to recent notifications
        addRecentNotification(data.message, 'group_join');
    });
    
    socket.on('new_group_expense', function(data) {
        console.log('New group expense:', data);
        showNotification(data.message, 'info');
        // Add to recent notifications
        addRecentNotification(data.message, 'group_expense');
    });
});

function updateUnreadCount(count) {
    const badge = document.querySelector('.notification-badge');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
}

function updatePendingInvitations(invitations) {
    const pendingSection = document.querySelector('.card-body');
    if (pendingSection && invitations.length > 0) {
        // This would require more complex DOM manipulation
        // For now, we'll just refresh the page
        location.reload();
    }
}

function addRecentNotification(message, type) {
    const notificationsContainer = document.querySelector('.card-body');
    if (notificationsContainer) {
        const notificationHtml = `
            <div class="notification-item mb-3 p-3 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-${type === 'group_join' ? 'user-plus text-success' : 'euro-sign text-warning'} me-2"></i>
                            <strong>${type === 'group_join' ? 'Nouveau membre dans le groupe' : 'Nouvelle dépense dans le groupe'}</strong>
                        </div>
                        <p class="mb-2 text-muted small">${message}</p>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            À l'instant
                        </small>
                    </div>
                    <div>
                        <span class="badge bg-primary">Nouveau</span>
                    </div>
                </div>
            </div>
        `;
        
        // Insert at the beginning of the notifications list
        notificationsContainer.insertAdjacentHTML('afterbegin', notificationHtml);
    }
}

function showNotification(message, type = 'info') {
    // Create a simple notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-bell me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function markAllAsRead() {
    fetch('/mark_all_notifications_read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recharger la page pour mettre à jour l'affichage
            location.reload();
        } else {
            alert('Erreur lors de la mise à jour des notifications');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la mise à jour des notifications');
    });
}

function markAsRead(notificationId) {
    fetch(`/mark_notification_read/${notificationId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Masquer le badge "Nouveau" pour cette notification
            const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationItem) {
                const badge = notificationItem.querySelector('.badge');
                if (badge) {
                    badge.style.display = 'none';
                }
                notificationItem.classList.remove('bg-light');
            }
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
    });
}

// Ajouter des gestionnaires d'événements pour marquer les notifications individuelles comme lues au clic
document.addEventListener('DOMContentLoaded', function() {
    const notificationItems = document.querySelectorAll('.notification-item');
    notificationItems.forEach(item => {
        item.addEventListener('click', function() {
            const notificationId = this.getAttribute('data-notification-id');
            if (notificationId && !this.classList.contains('bg-light')) {
                // La notification n'est pas marquée comme lue
                markAsRead(notificationId);
            }
        });
    });
});

// Styles pour les notifications
document.head.insertAdjacentHTML('beforeend', `
    <style>
        .notification-item {
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background-color: rgba(0,123,255,0.05);
            transform: translateX(5px);
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
    </style>
`);
</script>
{% endblock %}